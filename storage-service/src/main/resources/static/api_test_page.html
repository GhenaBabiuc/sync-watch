<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncWatch Storage API Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            border-right: 1px solid #e9ecef;
        }

        .tab:last-child {
            border-right: none;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4a5568;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }

        .form-group {
            flex: 1;
        }

        .form-group.small {
            flex: 0 0 120px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #4a5568;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        button.danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        button.secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        }

        .response {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .response.success {
            background: #c6f6d5;
            border: 1px solid #38a169;
            color: #2d5016;
        }

        .response.error {
            background: #fed7d7;
            border: 1px solid #e53e3e;
            color: #742a2a;
        }

        .file-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .file-upload.dragover {
            border-color: #667eea;
            background: #ebf8ff;
        }

        .progress-container {
            margin: 15px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-buttons button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.completed {
            background: #c6f6d5;
            color: #2d5016;
        }

        .status-badge.pending {
            background: #fef5e7;
            color: #7c2d12;
        }

        .status-badge.failed {
            background: #fed7d7;
            color: #742a2a;
        }
    </style>
</head>
<body>
<div class="header">
    <h1>üé¨ SyncWatch Storage API Test Console</h1>
    <p>Test all endpoints of your movie/series storage service</p>
</div>

<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="showTab('movies')">Movies</button>
        <button class="tab" onclick="showTab('series')">Series</button>
        <button class="tab" onclick="showTab('files')">File Upload</button>
        <button class="tab" onclick="showTab('search')">Search</button>
        <button class="tab" onclick="showTab('webhooks')">Webhooks</button>
    </div>

    <!-- Movies Tab -->
    <div id="movies" class="tab-content active">
        <div class="section">
            <div class="section-title">Create Movie</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="movie-title" placeholder="Enter movie title">
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <input type="number" id="movie-year" min="1900" max="2030" placeholder="2024">
                </div>
                <div class="form-group small">
                    <label>Duration (min)</label>
                    <input type="number" id="movie-duration" placeholder="120">
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="movie-description" rows="3" placeholder="Movie description"></textarea>
            </div>
            <button onclick="createMovie()">Create Movie</button>
            <div id="create-movie-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Get All Movies</div>
            <div class="form-row">
                <div class="form-group small">
                    <label>Page</label>
                    <input type="number" id="movies-page" value="0" min="0">
                </div>
                <div class="form-group small">
                    <label>Size</label>
                    <input type="number" id="movies-size" value="10" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Title Filter</label>
                    <input type="text" id="movies-title-filter" placeholder="Search by title">
                </div>
                <div class="form-group small">
                    <label>Year Filter</label>
                    <input type="number" id="movies-year-filter" placeholder="2024">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="getAllMovies()">Get Movies</button>
                </div>
            </div>
            <div id="movies-table-container"></div>
        </div>

        <div class="section">
            <div class="section-title">Get Movie by ID</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Movie ID *</label>
                    <input type="number" id="get-movie-id" placeholder="Enter movie ID">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="getMovieById()">Get Movie</button>
                </div>
            </div>
            <div id="get-movie-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Update Movie</div>
            <div class="form-row">
                <div class="form-group small">
                    <label>Movie ID *</label>
                    <input type="number" id="update-movie-id" placeholder="ID">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="update-movie-title" placeholder="New title">
                </div>
                <div class="form-group small">
                    <label>Year</label>
                    <input type="number" id="update-movie-year" placeholder="2024">
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="update-movie-description" rows="3" placeholder="Updated description"></textarea>
            </div>
            <button onclick="updateMovie()">Update Movie</button>
            <div id="update-movie-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Delete Movie</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Movie ID *</label>
                    <input type="number" id="delete-movie-id" placeholder="Enter movie ID">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button class="danger" onclick="deleteMovie()">Delete Movie</button>
                </div>
            </div>
            <div id="delete-movie-response" class="response" style="display: none;"></div>
        </div>
    </div>

    <div id="series" class="tab-content">
        <div class="section">
            <div class="section-title">Create Series</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="series-title" placeholder="Enter series title">
                </div>
                <div class="form-group small">
                    <label>Year</label>
                    <input type="number" id="series-year" min="1900" max="2030" placeholder="2024">
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="series-description" rows="3" placeholder="Series description"></textarea>
            </div>
            <button onclick="createSeries()">Create Series</button>
            <div id="create-series-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Get All Series</div>
            <div class="form-row">
                <div class="form-group small">
                    <label>Page</label>
                    <input type="number" id="series-page" value="0" min="0">
                </div>
                <div class="form-group small">
                    <label>Size</label>
                    <input type="number" id="series-size" value="10" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Title Filter</label>
                    <input type="text" id="series-title-filter" placeholder="Search by title">
                </div>
                <div class="form-group small">
                    <label>Year Filter</label>
                    <input type="number" id="series-year-filter" placeholder="2024">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="getAllSeries()">Get Series</button>
                </div>
            </div>
            <div id="series-table-container"></div>
        </div>

        <div class="section">
            <div class="section-title">Create Season</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Series ID *</label>
                    <input type="number" id="season-series-id" placeholder="Series ID">
                </div>
                <div class="form-group small">
                    <label>Season Number *</label>
                    <input type="number" id="season-number" min="1" max="50" placeholder="1">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="season-title" placeholder="Season title">
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="season-description" rows="3" placeholder="Season description"></textarea>
            </div>
            <button onclick="createSeason()">Create Season</button>
            <div id="create-season-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Create Episode</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Season ID *</label>
                    <input type="number" id="episode-season-id" placeholder="Season ID">
                </div>
                <div class="form-group small">
                    <label>Episode Number *</label>
                    <input type="number" id="episode-number" min="1" max="500" placeholder="1">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="episode-title" placeholder="Episode title">
                </div>
                <div class="form-group small">
                    <label>Duration (min)</label>
                    <input type="number" id="episode-duration" placeholder="45">
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="episode-description" rows="3" placeholder="Episode description"></textarea>
            </div>
            <button onclick="createEpisode()">Create Episode</button>
            <div id="create-episode-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Get Seasons & Episodes</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Series ID</label>
                    <input type="number" id="get-seasons-series-id" placeholder="Series ID">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="getSeasonsBySeries()">Get Seasons</button>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Season ID</label>
                    <input type="number" id="get-episodes-season-id" placeholder="Season ID">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="getEpisodesBySeason()">Get Episodes</button>
                </div>
            </div>
            <div id="seasons-episodes-response" class="response" style="display: none;"></div>
        </div>
    </div>

    <!-- Files Tab -->
    <div id="files" class="tab-content">
        <div class="section">
            <div class="section-title">Upload File</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Entity Type *</label>
                    <select id="upload-entity-type">
                        <option value="MOVIE">Movie</option>
                        <option value="EPISODE">Episode</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Entity ID *</label>
                    <input type="number" id="upload-entity-id" placeholder="Movie or Episode ID">
                </div>
                <div class="form-group">
                    <label>File Type *</label>
                    <select id="upload-file-type">
                        <option value="video">Video</option>
                        <option value="cover">Cover</option>
                    </select>
                </div>
            </div>

            <div class="file-upload" id="file-upload-area">
                <input type="file" id="upload-file" style="display: none;" accept="video/*,image/*">
                <div id="upload-text">
                    üìÅ Click to select file or drag and drop
                </div>
            </div>

            <div class="progress-container" id="upload-progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="upload-progress-fill">0%</div>
                </div>
                <div id="upload-status" style="margin-top: 10px; font-size: 14px;"></div>
            </div>

            <button id="start-upload-btn" onclick="startFileUpload()" disabled>Start Upload</button>
            <div id="upload-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Get Files</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Movie ID</label>
                    <input type="number" id="get-movie-files-id" placeholder="Movie ID">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="getMovieFiles()">Get Movie Files</button>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Episode ID</label>
                    <input type="number" id="get-episode-files-id" placeholder="Episode ID">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="getEpisodeFiles()">Get Episode Files</button>
                </div>
            </div>
            <div id="files-response" class="response" style="display: none;"></div>
        </div>
    </div>

    <div id="search" class="tab-content">
        <div class="section">
            <div class="section-title">Search All Content</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="search-title" placeholder="Search by title">
                </div>
                <div class="form-group small">
                    <label>Year</label>
                    <input type="number" id="search-year" placeholder="2024">
                </div>
                <div class="form-group small">
                    <label>Page</label>
                    <input type="number" id="search-page" value="0" min="0">
                </div>
                <div class="form-group small">
                    <label>Size</label>
                    <input type="number" id="search-size" value="20" min="1" max="100">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="searchAllContent()">Search</button>
                </div>
            </div>
            <div id="search-all-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Advanced Movie Search</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="movie-search-title" placeholder="Search by title">
                </div>
                <div class="form-group small">
                    <label>Min Duration</label>
                    <input type="number" id="movie-search-min-duration" placeholder="90">
                </div>
                <div class="form-group small">
                    <label>Max Duration</label>
                    <input type="number" id="movie-search-max-duration" placeholder="180">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="searchMovies()">Search Movies</button>
                </div>
            </div>
            <div id="movie-search-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Advanced Series Search</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="series-search-title" placeholder="Search by title">
                </div>
                <div class="form-group small">
                    <label>Min Seasons</label>
                    <input type="number" id="series-search-min-seasons" placeholder="1">
                </div>
                <div class="form-group small">
                    <label>Max Seasons</label>
                    <input type="number" id="series-search-max-seasons" placeholder="10">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="searchSeries()">Search Series</button>
                </div>
            </div>
            <div id="series-search-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Content Statistics & Recent</div>
            <div class="form-row">
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="getContentStats()">Get Statistics</button>
                </div>
                <div class="form-group small">
                    <label>Limit</label>
                    <input type="number" id="recent-limit" value="10" min="1" max="50">
                </div>
                <div class="form-group" style="flex: 0 0 auto;">
                    <button onclick="getRecentContent()">Get Recent</button>
                </div>
            </div>
            <div id="stats-recent-response" class="response" style="display: none;"></div>
        </div>
    </div>

    <div id="webhooks" class="tab-content">
        <div class="section">
            <div class="section-title">Webhook Health Check</div>
            <button onclick="checkWebhookHealth()">Check Health</button>
            <div id="webhook-health-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Test Webhook</div>
            <div class="form-group">
                <label>Test Payload (JSON)</label>
                <textarea id="webhook-payload" rows="5" placeholder='{"test": "data"}'></textarea>
            </div>
            <button onclick="testWebhook()">Send Test Webhook</button>
            <div id="webhook-test-response" class="response" style="display: none;"></div>
        </div>

        <div class="section">
            <div class="section-title">Simulate MinIO Notification</div>
            <div class="form-group">
                <label>MinIO Notification Payload (JSON)</label>
                <textarea id="minio-notification" rows="10"
                          placeholder='{"Records": [{"eventName": "s3:ObjectCreated:Put", "s3": {"bucket": {"name": "movie-storage"}, "object": {"key": "test-object.mp4"}}}]}'></textarea>
            </div>
            <button onclick="sendMinIONotification()">Send MinIO Notification</button>
            <div id="minio-notification-response" class="response" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8081/api';

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        document.getElementById(tabName).classList.add('active');

        event.target.classList.add('active');
    }

    function showResponse(elementId, response, isError = false) {
        const element = document.getElementById(elementId);
        element.textContent = JSON.stringify(response, null, 2);
        element.className = `response ${isError ? 'error' : 'success'}`;
        element.style.display = 'block';
    }

    function createDataTable(data, containerId) {
        const container = document.getElementById(containerId);
        if (!data || data.length === 0) {
            container.innerHTML = '<p>No data found.</p>';
            return;
        }

        const headers = Object.keys(data[0]);
        let html = '<table class="data-table"><thead><tr>';

        headers.forEach(header => {
            html += `<th>${header}</th>`;
        });
        html += '<th>Actions</th></tr></thead><tbody>';

        data.forEach(item => {
            html += '<tr>';
            headers.forEach(header => {
                let value = item[header];
                if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value);
                }
                if (String(value).length > 50) {
                    value = String(value).substring(0, 50) + '...';
                }
                html += `<td>${value || ''}</td>`;
            });

            html += '<td><div class="action-buttons">';
            html += `<button onclick="viewItem(${item.id}, '${item.constructor?.name || 'item'}')">View</button>`;
            if (item.id) {
                html += `<button class="danger" onclick="deleteItem(${item.id}, '${containerId}')">Delete</button>`;
            }
            html += '</div></td>';
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function viewItem(id, type) {
        alert(`Viewing ${type} with ID: ${id}`);
    }

    function deleteItem(id, containerType) {
        if (confirm(`Are you sure you want to delete item ${id}?`)) {
            let endpoint = '';
            if (containerType.includes('movie')) {
                endpoint = `/movies/${id}`;
            } else if (containerType.includes('series')) {
                endpoint = `/series/${id}`;
            }

            if (endpoint) {
                fetch(`${API_BASE}${endpoint}`, {method: 'DELETE'})
                    .then(response => {
                        if (response.ok) {
                            alert('Item deleted successfully');
                            // Refresh the table
                            if (containerType.includes('movie')) {
                                getAllMovies();
                            } else if (containerType.includes('series')) {
                                getAllSeries();
                            }
                        } else {
                            alert('Failed to delete item');
                        }
                    })
                    .catch(error => {
                        console.error('Delete error:', error);
                        alert('Error deleting item');
                    });
            }
        }
    }

    async function createMovie() {
        const data = {
            title: document.getElementById('movie-title').value,
            description: document.getElementById('movie-description').value,
            year: parseInt(document.getElementById('movie-year').value) || null,
            duration: parseInt(document.getElementById('movie-duration').value) || null
        };

        try {
            const response = await fetch(`${API_BASE}/movies`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await response.json();
            showResponse('create-movie-response', result, !response.ok);

            if (response.ok) {
                document.getElementById('movie-title').value = '';
                document.getElementById('movie-description').value = '';
                document.getElementById('movie-year').value = '';
                document.getElementById('movie-duration').value = '';
            }
        } catch (error) {
            showResponse('create-movie-response', {error: error.message}, true);
        }
    }

    async function getAllMovies() {
        const page = document.getElementById('movies-page').value;
        const size = document.getElementById('movies-size').value;
        const title = document.getElementById('movies-title-filter').value;
        const year = document.getElementById('movies-year-filter').value;

        const params = new URLSearchParams({
            page: page,
            size: size,
            ...(title && {title}),
            ...(year && {year})
        });

        try {
            const response = await fetch(`${API_BASE}/movies?${params}`);
            const result = await response.json();

            if (response.ok && result.content) {
                createDataTable(result.content, 'movies-table-container');
            } else {
                showResponse('movies-table-container', result, !response.ok);
            }
        } catch (error) {
            document.getElementById('movies-table-container').innerHTML =
                `<div class="response error">${error.message}</div>`;
        }
    }

    async function getMovieById() {
        const id = document.getElementById('get-movie-id').value;
        if (!id) return;

        try {
            const response = await fetch(`${API_BASE}/movies/${id}`);
            const result = await response.json();
            showResponse('get-movie-response', result, !response.ok);
        } catch (error) {
            showResponse('get-movie-response', {error: error.message}, true);
        }
    }

    async function updateMovie() {
        const id = document.getElementById('update-movie-id').value;
        if (!id) return;

        const data = {};
        const title = document.getElementById('update-movie-title').value;
        const year = document.getElementById('update-movie-year').value;
        const description = document.getElementById('update-movie-description').value;

        if (title) data.title = title;
        if (year) data.releaseYear = parseInt(year);
        if (description) data.description = description;

        try {
            const response = await fetch(`${API_BASE}/movies/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await response.json();
            showResponse('update-movie-response', result, !response.ok);
        } catch (error) {
            showResponse('update-movie-response', {error: error.message}, true);
        }
    }

    async function deleteMovie() {
        const id = document.getElementById('delete-movie-id').value;
        if (!id) return;

        if (!confirm(`Are you sure you want to delete movie ${id}?`)) return;

        try {
            const response = await fetch(`${API_BASE}/movies/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showResponse('delete-movie-response', {message: 'Movie deleted successfully'});
            } else {
                const result = await response.json();
                showResponse('delete-movie-response', result, true);
            }
        } catch (error) {
            showResponse('delete-movie-response', {error: error.message}, true);
        }
    }

    async function createSeries() {
        const data = {
            title: document.getElementById('series-title').value,
            description: document.getElementById('series-description').value,
            year: parseInt(document.getElementById('series-year').value) || null
        };

        try {
            const response = await fetch(`${API_BASE}/series`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await response.json();
            showResponse('create-series-response', result, !response.ok);

            if (response.ok) {
                document.getElementById('series-title').value = '';
                document.getElementById('series-description').value = '';
                document.getElementById('series-year').value = '';
            }
        } catch (error) {
            showResponse('create-series-response', {error: error.message}, true);
        }
    }

    async function getAllSeries() {
        const page = document.getElementById('series-page').value;
        const size = document.getElementById('series-size').value;
        const title = document.getElementById('series-title-filter').value;
        const year = document.getElementById('series-year-filter').value;

        const params = new URLSearchParams({
            page: page,
            size: size,
            ...(title && {title}),
            ...(year && {year})
        });

        try {
            const response = await fetch(`${API_BASE}/series?${params}`);
            const result = await response.json();

            if (response.ok && result.content) {
                createDataTable(result.content, 'series-table-container');
            } else {
                showResponse('series-table-container', result, !response.ok);
            }
        } catch (error) {
            document.getElementById('series-table-container').innerHTML =
                `<div class="response error">${error.message}</div>`;
        }
    }

    async function createSeason() {
        const data = {
            seriesId: parseInt(document.getElementById('season-series-id').value),
            seasonNumber: parseInt(document.getElementById('season-number').value),
            title: document.getElementById('season-title').value,
            description: document.getElementById('season-description').value
        };

        if (!data.seriesId || !data.seasonNumber) {
            alert('Series ID and Season Number are required');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/series/${data.seriesId}/seasons`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await response.json();
            showResponse('create-season-response', result, !response.ok);

            if (response.ok) {
                document.getElementById('season-series-id').value = '';
                document.getElementById('season-number').value = '';
                document.getElementById('season-title').value = '';
                document.getElementById('season-description').value = '';
            }
        } catch (error) {
            showResponse('create-season-response', {error: error.message}, true);
        }
    }

    async function createEpisode() {
        const seasonId = parseInt(document.getElementById('episode-season-id').value);
        const data = {
            seasonId: seasonId,
            episodeNumber: parseInt(document.getElementById('episode-number').value),
            title: document.getElementById('episode-title').value,
            description: document.getElementById('episode-description').value,
            duration: parseInt(document.getElementById('episode-duration').value) || null
        };

        if (!data.seasonId || !data.episodeNumber) {
            alert('Season ID and Episode Number are required');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/series/seasons/${seasonId}/episodes`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await response.json();
            showResponse('create-episode-response', result, !response.ok);

            if (response.ok) {
                document.getElementById('episode-season-id').value = '';
                document.getElementById('episode-number').value = '';
                document.getElementById('episode-title').value = '';
                document.getElementById('episode-description').value = '';
                document.getElementById('episode-duration').value = '';
            }
        } catch (error) {
            showResponse('create-episode-response', {error: error.message}, true);
        }
    }

    async function getSeasonsBySeries() {
        const seriesId = document.getElementById('get-seasons-series-id').value;
        if (!seriesId) return;

        try {
            const response = await fetch(`${API_BASE}/series/${seriesId}/seasons`);
            const result = await response.json();
            showResponse('seasons-episodes-response', {seasons: result}, !response.ok);
        } catch (error) {
            showResponse('seasons-episodes-response', {error: error.message}, true);
        }
    }

    async function getEpisodesBySeason() {
        const seasonId = document.getElementById('get-episodes-season-id').value;
        if (!seasonId) return;

        try {
            const response = await fetch(`${API_BASE}/series/seasons/${seasonId}/episodes`);
            const result = await response.json();
            showResponse('seasons-episodes-response', {episodes: result}, !response.ok);
        } catch (error) {
            showResponse('seasons-episodes-response', {error: error.message}, true);
        }
    }

    let selectedFile = null;

    document.addEventListener('DOMContentLoaded', function () {
        const uploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('upload-file');
        const uploadText = document.getElementById('upload-text');
        const startBtn = document.getElementById('start-upload-btn');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                selectedFile = file;
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                uploadText.innerHTML = `
                        üìÅ <strong>${file.name}</strong><br>
                        Size: ${sizeMB} MB<br>
                        Type: ${file.type}
                    `;
                startBtn.disabled = false;
            } else {
                selectedFile = null;
                uploadText.textContent = 'üìÅ Click to select file or drag and drop';
                startBtn.disabled = true;
            }
        }
    });

    async function startFileUpload() {
        if (!selectedFile) return;

        const entityType = document.getElementById('upload-entity-type').value;
        const entityId = parseInt(document.getElementById('upload-entity-id').value);
        const fileType = document.getElementById('upload-file-type').value;

        if (!entityId) {
            alert('Entity ID is required');
            return;
        }

        const uploadData = {
            originalFilename: selectedFile.name,
            mimeType: selectedFile.type,
            fileSize: selectedFile.size,
            entityId: entityId,
            entityType: entityType,
            fileType: fileType
        };

        try {
            document.getElementById('start-upload-btn').disabled = true;
            showProgressContainer(true);
            updateProgress(0, 'Initiating upload...');

            const response = await fetch(`${API_BASE}/files/upload`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(uploadData)
            });

            if (!response.ok) {
                throw new Error(`Failed to initiate upload: ${response.statusText}`);
            }

            const uploadSession = await response.json();
            showResponse('upload-response', uploadSession);

            await uploadFileToPresignedUrl(selectedFile, uploadSession.presignedUrl);

            updateProgress(100, 'Upload completed successfully!');

            setTimeout(() => {
                resetUploadForm();
            }, 3000);

        } catch (error) {
            console.error('Upload error:', error);
            showResponse('upload-response', {error: error.message}, true);
            document.getElementById('start-upload-btn').disabled = false;
            showProgressContainer(false);
        }
    }

    async function uploadFileToPresignedUrl(file, presignedUrl) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const progress = Math.round((e.loaded / e.total) * 90) + 5; // 5-95%
                    updateProgress(progress, `Uploading... ${(e.loaded / (1024 * 1024)).toFixed(1)} MB / ${(e.total / (1024 * 1024)).toFixed(1)} MB`);
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    updateProgress(95, 'Upload completed, processing...');
                    resolve();
                } else {
                    reject(new Error(`Upload failed with status ${xhr.status}`));
                }
            };

            xhr.onerror = () => reject(new Error('Network error during upload'));

            xhr.open('PUT', presignedUrl);
            xhr.setRequestHeader('Content-Type', file.type);
            xhr.send(file);
        });
    }

    function updateProgress(percent, message) {
        const progressFill = document.getElementById('upload-progress-fill');
        const uploadStatus = document.getElementById('upload-status');

        progressFill.style.width = `${percent}%`;
        progressFill.textContent = `${percent}%`;
        uploadStatus.textContent = message;
    }

    function showProgressContainer(show) {
        const container = document.getElementById('upload-progress-container');
        container.style.display = show ? 'block' : 'none';
    }

    function resetUploadForm() {
        selectedFile = null;
        document.getElementById('upload-file').value = '';
        document.getElementById('upload-text').textContent = 'üìÅ Click to select file or drag and drop';
        document.getElementById('start-upload-btn').disabled = true;
        showProgressContainer(false);
    }

    async function getMovieFiles() {
        const movieId = document.getElementById('get-movie-files-id').value;
        if (!movieId) return;

        try {
            const response = await fetch(`${API_BASE}/files/movie/${movieId}`);
            const result = await response.json();
            showResponse('files-response', result, !response.ok);
        } catch (error) {
            showResponse('files-response', {error: error.message}, true);
        }
    }

    async function getEpisodeFiles() {
        const episodeId = document.getElementById('get-episode-files-id').value;
        if (!episodeId) return;

        try {
            const response = await fetch(`${API_BASE}/files/episode/${episodeId}`);
            const result = await response.json();
            showResponse('files-response', result, !response.ok);
        } catch (error) {
            showResponse('files-response', {error: error.message}, true);
        }
    }

    async function searchAllContent() {
        const title = document.getElementById('search-title').value;
        const year = document.getElementById('search-year').value;
        const page = document.getElementById('search-page').value;
        const size = document.getElementById('search-size').value;

        const params = new URLSearchParams({
            page: page,
            size: size,
            ...(title && {title}),
            ...(year && {year})
        });

        try {
            const response = await fetch(`${API_BASE}/content/search?${params}`);
            const result = await response.json();
            showResponse('search-all-response', result, !response.ok);
        } catch (error) {
            showResponse('search-all-response', {error: error.message}, true);
        }
    }

    async function searchMovies() {
        const title = document.getElementById('movie-search-title').value;
        const minDuration = document.getElementById('movie-search-min-duration').value;
        const maxDuration = document.getElementById('movie-search-max-duration').value;

        const params = new URLSearchParams({
            page: 0,
            size: 20,
            ...(title && {title}),
            ...(minDuration && {minDuration}),
            ...(maxDuration && {maxDuration})
        });

        try {
            const response = await fetch(`${API_BASE}/content/movies/search?${params}`);
            const result = await response.json();
            showResponse('movie-search-response', result, !response.ok);
        } catch (error) {
            showResponse('movie-search-response', {error: error.message}, true);
        }
    }

    async function searchSeries() {
        const title = document.getElementById('series-search-title').value;
        const minSeasons = document.getElementById('series-search-min-seasons').value;
        const maxSeasons = document.getElementById('series-search-max-seasons').value;

        const params = new URLSearchParams({
            page: 0,
            size: 20,
            ...(title && {title}),
            ...(minSeasons && {minSeasons}),
            ...(maxSeasons && {maxSeasons})
        });

        try {
            const response = await fetch(`${API_BASE}/content/series/search?${params}`);
            const result = await response.json();
            showResponse('series-search-response', result, !response.ok);
        } catch (error) {
            showResponse('series-search-response', {error: error.message}, true);
        }
    }

    async function getContentStats() {
        try {
            const response = await fetch(`${API_BASE}/content/stats`);
            const result = await response.json();
            showResponse('stats-recent-response', result, !response.ok);
        } catch (error) {
            showResponse('stats-recent-response', {error: error.message}, true);
        }
    }

    async function getRecentContent() {
        const limit = document.getElementById('recent-limit').value || 10;

        try {
            const response = await fetch(`${API_BASE}/content/recent?limit=${limit}`);
            const result = await response.json();
            showResponse('stats-recent-response', result, !response.ok);
        } catch (error) {
            showResponse('stats-recent-response', {error: error.message}, true);
        }
    }

    async function checkWebhookHealth() {
        try {
            const response = await fetch(`${API_BASE}/webhooks/minio/health`);
            const result = await response.json();
            showResponse('webhook-health-response', result, !response.ok);
        } catch (error) {
            showResponse('webhook-health-response', {error: error.message}, true);
        }
    }

    async function testWebhook() {
        let payload = {};
        const payloadText = document.getElementById('webhook-payload').value.trim();

        if (payloadText) {
            try {
                payload = JSON.parse(payloadText);
            } catch (error) {
                alert('Invalid JSON payload');
                return;
            }
        }

        try {
            const response = await fetch(`${API_BASE}/webhooks/minio/test`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            showResponse('webhook-test-response', result, !response.ok);
        } catch (error) {
            showResponse('webhook-test-response', {error: error.message}, true);
        }
    }

    async function sendMinIONotification() {
        let payload = {};
        const payloadText = document.getElementById('minio-notification').value.trim();

        if (!payloadText) {
            payload = {
                "Records": [{
                    "eventName": "s3:ObjectCreated:Put",
                    "s3": {
                        "bucket": {"name": "movie-storage"},
                        "object": {"key": "test-object.mp4"}
                    }
                }]
            };
        } else {
            try {
                payload = JSON.parse(payloadText);
            } catch (error) {
                alert('Invalid JSON payload');
                return;
            }
        }

        try {
            const response = await fetch(`${API_BASE}/webhooks/minio/notification`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            showResponse('minio-notification-response', result, !response.ok);
        } catch (error) {
            showResponse('minio-notification-response', {error: error.message}, true);
        }
    }
</script>
</body>
</html>

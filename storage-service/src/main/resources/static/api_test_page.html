<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncWatch Admin Dashboard</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #38a169;
            --danger: #e53e3e;
            --warning: #d69e2e;
            --bg: #f7fafc;
            --text: #2d3748;
            --border: #e2e8f0;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            padding-bottom: 300px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #718096;
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 0.85rem;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: #ebf8ff;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .entity-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            display: grid;
            grid-template-columns: 60px 2fr 1.5fr 140px 100px;
            align-items: center;
            gap: 15px;
            transition: all 0.2s;
        }

        .entity-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .nested-item {
            margin-left: 20px;
            border-left: 3px solid var(--border);
            padding-left: 15px;
        }

        .nested-container {
            display: none;
            margin-top: 10px;
        }

        .nested-container.open {
            display: block;
        }

        .status-badge {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .status-ok {
            color: var(--success);
        }

        .status-missing {
            color: #cbd5e0;
        }

        .status-missing-important {
            color: var(--danger);
        }

        .drop-target {
            border: 2px dashed #cbd5e0;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
        }

        .drop-target.dragover {
            background: #ebf8ff;
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .upload-controls select {
            font-size: 0.75rem;
            padding: 2px;
            margin-bottom: 4px;
            width: auto;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        #upload-manager {
            position: fixed;
            bottom: 0;
            right: 20px;
            width: 400px;
            background: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
            max-height: 500px;
        }

        #upload-manager.minimized {
            transform: translateY(calc(100% - 40px));
        }

        .um-header {
            padding: 10px 15px;
            background: #2d3748;
            color: white;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .um-body {
            overflow-y: auto;
            padding: 10px;
            flex: 1;
            background: #f7fafc;
            height: 300px;
        }

        .upload-task {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .progress-bar-bg {
            height: 4px;
            background: #edf2f7;
            margin-top: 8px;
            border-radius: 2px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.2s;
        }
    </style>
</head>
<body>

<div class="header">
    <h2>汐 SyncWatch Admin</h2>
    <button class="btn btn-sm" onclick="alert('Simulating Webhooks automatically post-upload.')">Webhook Status: Auto
    </button>
</div>

<div class="container">
    <div class="tabs">
        <div class="tab active" onclick="switchTab('movies')">Movies</div>
        <div class="tab" onclick="switchTab('series')">Series & TV</div>
    </div>

    <div id="movies" class="tab-content active">
        <div class="card">
            <div class="toolbar">
                <h3>Movies Library</h3>
                <button class="btn btn-success" onclick="openModal('MOVIE', null)">+ Add Movie</button>
            </div>

            <div id="movies-list">Loading...</div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-outline" onclick="changeMoviePage(-1)">Previous</button>
                <span id="movie-page-indicator" style="margin: 0 15px;">Page 1</span>
                <button class="btn btn-outline" onclick="changeMoviePage(1)">Next</button>
            </div>
        </div>
    </div>

    <div id="series" class="tab-content">
        <div class="card">
            <div class="toolbar">
                <h3>Series Library</h3>
                <button class="btn btn-success" onclick="openModal('SERIES', null)">+ Add Series</button>
            </div>
            <p style="color:#718096; font-size:0.9rem; margin-bottom:15px;">Expand Series > Seasons > Episodes to manage
                content.</p>
            <div id="series-list">Loading...</div>
        </div>
    </div>
</div>

<div id="crud-modal" class="modal-overlay">
    <div class="modal">
        <h3 id="modal-title">Create Entity</h3>
        <form id="crud-form" onsubmit="handleFormSubmit(event)">
            <input type="hidden" id="entity-id">
            <input type="hidden" id="entity-type">
            <input type="hidden" id="parent-id">

            <div class="form-group" id="field-parent-info"
                 style="display:none; color: #718096; font-size: 0.9rem;"></div>

            <div class="form-group" id="field-number" style="display:none;">
                <label id="label-number">Number</label>
                <input type="number" id="input-number" min="1">
            </div>

            <div class="form-group">
                <label>Title</label>
                <input type="text" id="input-title" required placeholder="Main Title">
            </div>

            <div class="form-group" id="field-year">
                <label>Year</label>
                <input type="number" id="input-year" min="1900" max="2030">
            </div>

            <div class="form-group" id="field-duration" style="display:none;">
                <label>Duration (minutes)</label>
                <input type="number" id="input-duration">
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="input-description" rows="3"></textarea>
            </div>

            <div style="display:flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="upload-manager">
    <div class="um-header" onclick="document.getElementById('upload-manager').classList.toggle('minimized')">
        <span>Active Uploads (<span id="active-count">0</span>)</span>
        <span>▼</span>
    </div>
    <div class="um-body" id="upload-queue">
        <div style="text-align:center; color:#a0aec0; margin-top:20px;">No uploads active</div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8081/api';
    let moviePage = 0;
    const pageSize = 10;
    const uploadQueue = [];
    let activeUploads = 0;

    document.addEventListener('DOMContentLoaded', () => {
        loadMovies();
        loadSeries();
        setInterval(processUploadQueue, 1000);
    });

    function switchTab(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    function renderMovieStatus(hasVideo, hasPoster) {
        return `
            <div style="text-align:center; display:flex; flex-direction:column;">
                <span class="status-badge ${hasVideo ? 'status-ok' : 'status-missing-important'}">
                    ${hasVideo ? '✅ Video OK' : '❌ No Video'}
                </span>
                <span class="status-badge ${hasPoster ? 'status-ok' : 'status-missing'}">
                    ${hasPoster ? '✅ Cover OK' : '⚪ No Cover'}
                </span>
            </div>
        `;
    }

    function renderEpisodeStatus(hasVideo, hasThumb) {
        return `
            <div style="text-align:center; display:flex; flex-direction:column;">
                <span class="status-badge ${hasVideo ? 'status-ok' : 'status-missing-important'}">
                    ${hasVideo ? '✅ Video OK' : '❌ No Video'}
                </span>
                <span class="status-badge ${hasThumb ? 'status-ok' : 'status-missing'}">
                    ${hasThumb ? '✅ Thumb OK' : '⚪ No Thumb'}
                </span>
            </div>
        `;
    }

    function renderSeriesStatus(hasPoster) {
        return `
            <div style="text-align:center; display:flex; flex-direction:column; justify-content:center; height:100%;">
                <span class="status-badge ${hasPoster ? 'status-ok' : 'status-missing'}">
                    ${hasPoster ? '✅ Cover OK' : '⚪ No Cover'}
                </span>
            </div>
        `;
    }

    async function loadMovies() {
        const list = document.getElementById('movies-list');
        try {
            const res = await fetch(`${API_BASE}/movies?page=${moviePage}&size=${pageSize}`);
            const data = await res.json();

            document.getElementById('movie-page-indicator').innerText = `Page ${moviePage + 1} / ${data.totalPages}`;
            list.innerHTML = '';

            data.content.forEach(m => {
                const hasVideo = m.mediaFiles.some(f => f.category === 'VIDEO' && f.uploadStatus === 'COMPLETED');
                const hasPoster = m.mediaFiles.some(f => f.category === 'POSTER' && f.uploadStatus === 'COMPLETED');

                const html = `
                    <div class="entity-item">
                        <div style="font-weight:bold; color:#a0aec0;">#${m.id}</div>
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem;">${m.title}</div>
                            <div style="font-size:0.85rem; color:#718096;">${m.year || '?'} • ${m.duration || '?'} min</div>
                        </div>

                        <div class="drop-target"
                             ondragover="event.preventDefault(); this.classList.add('dragover');"
                             ondragleave="this.classList.remove('dragover');"
                             ondrop="handleDrop(event, 'MOVIE', ${m.id})">
                             <div class="upload-controls">
                                <select id="cat-movie-${m.id}" onclick="event.stopPropagation()">
                                    <option value="VIDEO">Video File</option>
                                    <option value="POSTER">Cover Image</option>
                                    <option value="BACKDROP">Backdrop</option>
                                </select>
                            </div>
                            <div style="font-size:0.8rem; color:#718096;">Drop File</div>
                        </div>

                        ${renderMovieStatus(hasVideo, hasPoster)}

                        <div style="display:flex; gap:5px; justify-content:flex-end;">
                            <button class="btn btn-sm btn-outline" onclick='openModal("MOVIE", ${JSON.stringify(m).replace(/'/g, "&#39;")})'>Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEntity('movies', ${m.id})">Del</button>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });
        } catch (e) {
            list.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
        }
    }

    async function loadSeries() {
        const list = document.getElementById('series-list');
        list.innerHTML = 'Loading...';
        try {
            const res = await fetch(`${API_BASE}/series?size=100`);
            const data = await res.json();
            list.innerHTML = '';

            data.content.forEach(s => {
                const hasPoster = s.mediaFiles && s.mediaFiles.some(f => f.category === 'POSTER' && f.uploadStatus === 'COMPLETED');

                const html = `
                    <div class="entity-item" style="background:#f8fafc; border-left: 4px solid var(--secondary);">
                        <div style="font-weight:bold;">S:${s.id}</div>
                        <div>
                            <strong>${s.title}</strong> (${s.year || '-'})
                            <div style="margin-top: 5px;">
                                <button class="btn btn-sm btn-outline" onclick="toggleSeasons(this, ${s.id}, '${s.title.replace(/'/g, "\\'")}')">Show Seasons</button>
                            </div>
                        </div>

                        <div class="drop-target"
                             ondragover="event.preventDefault(); this.classList.add('dragover');"
                             ondragleave="this.classList.remove('dragover');"
                             ondrop="handleDrop(event, 'SERIES', ${s.id})">
                             <div class="upload-controls">
                                <select id="cat-series-${s.id}" onclick="event.stopPropagation()">
                                    <option value="POSTER">Series Cover</option>
                                    <option value="BACKDROP">Backdrop</option>
                                </select>
                            </div>
                            <div style="font-size:0.8rem; color:#718096;">Drop File</div>
                        </div>

                        ${renderSeriesStatus(hasPoster)}

                        <div style="display:flex; gap:5px; justify-content:flex-end;">
                            <button class="btn btn-sm btn-outline" onclick='openModal("SERIES", ${JSON.stringify(s).replace(/'/g, "&#39;")})'>Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEntity('series', ${s.id})">Del</button>
                        </div>
                    </div>
                    <div id="seasons-container-${s.id}" class="nested-container nested-item"></div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });
        } catch (e) {
            console.error(e);
        }
    }

    async function toggleSeasons(btn, seriesId, seriesTitle) {
        const container = document.getElementById(`seasons-container-${seriesId}`);
        if (container.classList.contains('open')) {
            container.classList.remove('open');
            btn.innerText = "Show Seasons";
            return;
        }

        btn.innerText = "Loading...";
        try {
            const res = await fetch(`${API_BASE}/series/${seriesId}/seasons`);
            const data = await res.json();

            let html = `
                <div style="margin: 10px 0; display:flex; gap: 10px;">
                    <button class="btn btn-sm btn-success" onclick="openModal('SEASON', null, ${seriesId})">+ Add Season</button>
                    <button class="btn btn-sm btn-outline" style="background-color: #ebf8ff;" onclick="batchCreateSeasons(${seriesId})">++ Batch Seasons</button>
                </div>
            `;

            data.content.forEach(s => {
                html += `
                    <div class="entity-item">
                        <div>Sn:${s.seasonNumber}</div>
                        <div>${s.title || `Season ${s.seasonNumber}`}</div>
                        <div style="text-align:center; color:#ccc; font-size:0.8rem;">(Season Container)</div>
                        <div style="grid-column: span 1">
                            <button class="btn btn-sm btn-outline" onclick="toggleEpisodes(this, ${s.id}, ${s.seasonNumber})">Show Episodes</button>
                        </div>
                        <div style="display:flex; gap:5px; justify-content:flex-end;">
                            <button class="btn btn-sm btn-outline" onclick='openModal("SEASON", ${JSON.stringify(s).replace(/'/g, "&#39;")})'>Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEntity('series/seasons', ${s.id})">Del</button>
                        </div>
                    </div>
                    <div id="episodes-container-${s.id}" class="nested-container nested-item" style="border-left-color: var(--success);"></div>
                `;
            });
            container.innerHTML = html;
            container.classList.add('open');
            btn.innerText = "Hide Seasons";
        } catch (e) {
            console.error(e);
            alert("Error loading seasons");
            btn.innerText = "Show Seasons";
        }
    }

    async function batchCreateSeasons(seriesId) {
        const countStr = prompt("How many seasons to create?", "5");
        if (!countStr) return;
        const count = parseInt(countStr);
        if (isNaN(count) || count <= 0) return alert("Invalid count");

        const startStr = prompt("Start from season number?", "1");
        const startNum = parseInt(startStr) || 1;

        if (!confirm(`Are you sure you want to create ${count} seasons starting from Season ${startNum}?`)) return;

        let successCount = 0;

        console.log(`Starting batch creation for series ${seriesId}...`);

        for (let i = 0; i < count; i++) {
            const seasonNum = startNum + i;
            try {
                const body = {
                    seriesId: seriesId,
                    seasonNumber: seasonNum,
                    title: `Season ${seasonNum}`,
                    description: `Automatically generated description for Season ${seasonNum}`
                };

                const res = await fetch(`${API_BASE}/series/${seriesId}/seasons`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                if (res.ok) successCount++;
                else {
                    const err = await res.json();
                    console.error(`Failed to create season ${seasonNum}:`, err);
                }
            } catch (e) {
                console.error(`Error creating season ${seasonNum}`, e);
            }
        }

        alert(`Batch process finished. Created ${successCount} of ${count} seasons. Please manually refresh the list (click Hide/Show Seasons).`);
    }

    async function batchCreateEpisodes(seasonId) {
        const countStr = prompt("How many episodes to create?", "10");
        if (!countStr) return;
        const count = parseInt(countStr);
        if (isNaN(count) || count <= 0) return alert("Invalid count");

        const startStr = prompt("Start from episode number?", "1");
        const startNum = parseInt(startStr) || 1;

        if (!confirm(`Are you sure you want to create ${count} episodes starting from Episode ${startNum}?`)) return;

        let successCount = 0;
        console.log(`Starting batch creation for season ${seasonId}...`);

        for (let i = 0; i < count; i++) {
            const epNum = startNum + i;
            try {
                const body = {
                    seasonId: seasonId,
                    episodeNumber: epNum,
                    title: `Episode ${epNum}`,
                    description: `Automatically generated description for Episode ${epNum}`,
                    duration: 45
                };

                const res = await fetch(`${API_BASE}/series/seasons/${seasonId}/episodes`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                if (res.ok) successCount++;
                else {
                    const err = await res.json();
                    console.error(`Failed to create episode ${epNum}:`, err);
                }
            } catch (e) {
                console.error(`Error creating episode ${epNum}`, e);
            }
        }

        alert(`Batch process finished. Created ${successCount} of ${count} episodes. Please manually refresh the list (click Hide/Show Episodes).`);
    }

    async function toggleEpisodes(btn, seasonId, seasonNum) {
        const container = document.getElementById(`episodes-container-${seasonId}`);
        if (container.classList.contains('open')) {
            container.classList.remove('open');
            btn.innerText = "Show Episodes";
            return;
        }

        btn.innerText = "Loading...";
        try {
            const res = await fetch(`${API_BASE}/series/seasons/${seasonId}/episodes`);
            const data = await res.json();

            let html = `
                <div style="margin: 10px 0; display:flex; gap: 10px;">
                    <button class="btn btn-sm btn-success" onclick="openModal('EPISODE', null, ${seasonId})">+ Add Episode</button>
                    <button class="btn btn-sm btn-outline" style="background-color: #ebf8ff;" onclick="batchCreateEpisodes(${seasonId})">++ Batch Episodes</button>
                </div>
            `;

            data.content.forEach(ep => {
                const hasVideo = ep.mediaFiles && ep.mediaFiles.some(m => m.category === 'VIDEO' && m.uploadStatus === 'COMPLETED');
                const hasThumb = ep.mediaFiles && ep.mediaFiles.some(m => m.category === 'POSTER' && m.uploadStatus === 'COMPLETED');

                html += `
                    <div class="entity-item">
                        <div style="color:#718096;">Ep:${ep.episodeNumber}</div>
                        <div>
                            <strong>${ep.title || `Episode ${ep.episodeNumber}`}</strong>
                            <div style="font-size:0.8rem; color:#718096;">${ep.duration ? ep.duration + ' min' : ''}</div>
                        </div>

                        <div class="drop-target"
                             ondragover="event.preventDefault(); this.classList.add('dragover');"
                             ondragleave="this.classList.remove('dragover');"
                             ondrop="handleDrop(event, 'EPISODE', ${ep.id})">
                             <div class="upload-controls">
                                <select id="cat-ep-${ep.id}" onclick="event.stopPropagation()">
                                    <option value="VIDEO">Video File</option>
                                    <option value="POSTER">Thumbnail</option>
                                </select>
                            </div>
                            <div style="font-size:0.8rem; color:#718096;">Drop File</div>
                        </div>

                        ${renderEpisodeStatus(hasVideo, hasThumb)}

                        <div style="display:flex; gap:5px; justify-content:flex-end;">
                            <button class="btn btn-sm btn-outline" onclick='openModal("EPISODE", ${JSON.stringify(ep).replace(/'/g, "&#39;")})'>Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEntity('series/episodes', ${ep.id})">Del</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            container.classList.add('open');
            btn.innerText = "Hide Episodes";
        } catch (e) {
            console.error(e);
            alert("Error loading episodes");
            btn.innerText = "Show Episodes";
        }
    }

    function openModal(type, entityData = null, parentId = null) {
        document.getElementById('crud-modal').classList.add('open');
        const form = document.getElementById('crud-form');
        form.reset();

        document.getElementById('entity-type').value = type;
        document.getElementById('entity-id').value = entityData ? entityData.id : '';
        document.getElementById('parent-id').value = parentId || '';
        document.getElementById('modal-title').innerText = (entityData ? "Edit " : "Create ") + type;

        const fYear = document.getElementById('field-year');
        const fNum = document.getElementById('field-number');
        const fDur = document.getElementById('field-duration');
        const fParent = document.getElementById('field-parent-info');

        fYear.style.display = (type === 'MOVIE' || type === 'SERIES') ? 'block' : 'none';
        fNum.style.display = (type === 'SEASON' || type === 'EPISODE') ? 'block' : 'none';
        fDur.style.display = (type === 'MOVIE' || type === 'EPISODE') ? 'block' : 'none';

        if (parentId) {
            fParent.style.display = 'block';
            fParent.innerText = `Adding to parent ID: ${parentId}`;
        } else {
            fParent.style.display = 'none';
        }
        document.getElementById('label-number').innerText = type === 'SEASON' ? 'Season Number' : 'Episode Number';

        if (entityData) {
            document.getElementById('input-title').value = entityData.title || '';
            document.getElementById('input-description').value = entityData.description || '';
            if (type === 'MOVIE' || type === 'SERIES') document.getElementById('input-year').value = entityData.year || '';
            if (type === 'MOVIE' || type === 'EPISODE') document.getElementById('input-duration').value = entityData.duration || '';

            if (type === 'SEASON') document.getElementById('input-number').value = entityData.seasonNumber;
            if (type === 'EPISODE') document.getElementById('input-number').value = entityData.episodeNumber;

            if ((type === 'SEASON' || type === 'EPISODE')) document.getElementById('input-number').disabled = true;
        } else {
            document.getElementById('input-number').disabled = false;
        }
    }

    function closeModal() {
        document.getElementById('crud-modal').classList.remove('open');
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const type = document.getElementById('entity-type').value;
        const id = document.getElementById('entity-id').value;
        const parentId = document.getElementById('parent-id').value;
        const isUpdate = !!id;

        const body = {
            title: document.getElementById('input-title').value,
            description: document.getElementById('input-description').value
        };

        if (type === 'MOVIE' || type === 'SERIES') body.year = parseInt(document.getElementById('input-year').value) || null;
        if (type === 'MOVIE' || type === 'EPISODE') body.duration = parseInt(document.getElementById('input-duration').value) || null;

        let url = '';
        let method = isUpdate ? 'PUT' : 'POST';

        if (type === 'MOVIE') {
            url = isUpdate ? `/movies/${id}` : '/movies';
        } else if (type === 'SERIES') {
            url = isUpdate ? `/series/${id}` : '/series';
        } else if (type === 'SEASON') {
            if (!isUpdate) {
                body.seriesId = parentId;
                body.seasonNumber = parseInt(document.getElementById('input-number').value);
                url = `/series/${parentId}/seasons`;
            } else {
                url = `/series/seasons/${id}`;
            }
        } else if (type === 'EPISODE') {
            if (!isUpdate) {
                body.seasonId = parentId;
                body.episodeNumber = parseInt(document.getElementById('input-number').value);
                url = `/series/seasons/${parentId}/episodes`;
            } else {
                url = `/series/episodes/${id}`;
            }
        }

        try {
            const res = await fetch(API_BASE + url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });

            if (!res.ok) throw new Error((await res.json()).message || "Save failed");

            closeModal();
            if (type === 'MOVIE') loadMovies();
            else if (type === 'SERIES') loadSeries();
            else if (type === 'SEASON' || type === 'EPISODE') {
                alert("Saved. Please click 'Show/Hide' on the parent to refresh the list.");
            }

        } catch (err) {
            alert("Error: " + err.message);
        }
    }

    async function deleteEntity(endpointType, id) {
        if (!confirm("Are you sure? This will delete all files associated with this entity.")) return;
        try {
            const res = await fetch(`${API_BASE}/${endpointType}/${id}`, {method: 'DELETE'});
            if (res.ok) {
                if (endpointType === 'movies') loadMovies();
                else if (endpointType === 'series') loadSeries();
                else alert("Deleted. Please refresh the parent list.");
            } else {
                alert("Delete failed");
            }
        } catch (e) {
            alert("Error deleting");
        }
    }

    function changeMoviePage(delta) {
        if (moviePage + delta < 0) return;
        moviePage += delta;
        loadMovies();
    }

    function handleDrop(e, type, id) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length === 0) return;

        let category = 'VIDEO';
        if (type === 'MOVIE') category = document.getElementById(`cat-movie-${id}`).value;
        if (type === 'EPISODE') category = document.getElementById(`cat-ep-${id}`).value;
        if (type === 'SERIES') category = document.getElementById(`cat-series-${id}`).value;

        for (let i = 0; i < files.length; i++) {
            addToQueue(files[i], type, id, category);
        }
        document.getElementById('upload-manager').classList.remove('minimized');
    }

    function addToQueue(file, type, id, category) {
        uploadQueue.push({
            id: 'task-' + Date.now() + Math.random(),
            file, type, entityId: id, category,
            status: 'PENDING', progress: 0
        });
        renderQueue();
    }

    function renderQueue() {
        const c = document.getElementById('upload-queue');
        document.getElementById('active-count').innerText = uploadQueue.length;
        if (uploadQueue.length === 0) {
            c.innerHTML = '<div style="text-align:center; color:#a0aec0; margin-top:20px;">No uploads</div>';
            return;
        }

        c.innerHTML = '';
        uploadQueue.forEach(task => {
            const color = task.status === 'COMPLETED' ? 'var(--success)' : (task.status === 'ERROR' ? '#e53e3e' : 'var(--primary)');
            c.innerHTML += `
                <div class="upload-task">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${task.file.name}</b>
                        <span style="color:${color}; font-size:0.75rem;">${task.status}</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width:${task.progress}%"></div>
                    </div>
                </div>
            `;
        });
    }

    function processUploadQueue() {
        if (activeUploads >= 3) return;
        const task = uploadQueue.find(t => t.status === 'PENDING');
        if (!task) return;

        task.status = 'UPLOADING';
        activeUploads++;
        renderQueue();

        startUpload(task).finally(() => {
            activeUploads--;
            renderQueue();
        });
    }

    async function startUpload(task) {
        try {
            const initRes = await fetch(`${API_BASE}/files/upload`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    originalFilename: task.file.name,
                    mimeType: task.file.type || 'application/octet-stream',
                    fileSize: task.file.size,
                    entityId: task.entityId,
                    entityType: task.type,
                    category: task.category,
                    // If category is POSTER (Cover/Thumb), assume primary for simplicity in this demo
                    isPrimary: task.category === 'POSTER'
                })
            });
            if (!initRes.ok) throw new Error("Init failed");
            const session = await initRes.json();

            await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', session.presignedUrl);
                xhr.upload.onprogress = e => {
                    if (e.lengthComputable) {
                        task.progress = (e.loaded / e.total) * 100;
                        renderQueue();
                    }
                };
                xhr.onload = () => xhr.status === 200 ? resolve() : reject();
                xhr.onerror = () => reject();
                xhr.send(task.file);
            });

            await fetch(`${API_BASE}/webhooks/minio/notification`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    "Records": [{
                        "eventName": "s3:ObjectCreated:Put",
                        "s3": {"bucket": {"name": "movie-storage"}, "object": {"key": session.minioObjectKey}}
                    }]
                })
            });

            task.status = 'COMPLETED';
            task.progress = 100;
        } catch (e) {
            console.error(e);
            task.status = 'ERROR';
        }
    }
</script>
</body>
</html>
